stages:
  - test
  - report

pytest:
  stage: test
  image: python:3.11
  allow_failure: true
  script:
    - pip install -r requirements.txt
    - mkdir -p allure-results
    - pytest --alluredir=allure-results || true
  artifacts:
    when: always
    paths:
      - allure-results/
    expire_in: 7 days

allure_report:
  stage: report
  image: adoptopenjdk/openjdk11:latest
  script:
    - apt-get update && apt-get install -y wget unzip
    - wget https://repo.maven.apache.org/maven2/io/qameta/allure/allure-commandline/2.24.0/allure-commandline-2.24.0.zip
    - unzip allure-commandline-2.24.0.zip -d /opt/allure
    - export PATH=/opt/allure/allure-2.24.0/bin:$PATH
    - allure generate allure-results --clean -o allure-report
  artifacts:
    when: always
    paths:
      - allure-report/
    expire_in: 7 days
  dependencies:
    - pytest